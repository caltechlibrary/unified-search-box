<!DOCTYPE html>
<html>
<head>
  <title>Unified Search Box prototypes</title>
  <link href="css/page-basic.css" rel="stylesheet">
  <style>
/*
 * These are classes for general layout
 */
body {
   padding: 0;
   margin: 0;
   font-size: 16px;
}

h1 {
    text-font-size: 1em;
    text-transform: uppercase;
}

a, a:hover, a:link, a:active, a:visited, a:focus {
    color: blue;
}

.unified-search {
    max-width: 80%;
    padding: 0.0em;
    margin: 0.0em;
}

.unified-search h1 {
    font-size: 1em;
}

.unified-search a, a:link, a:visited {
    text-decoration: none;
}

.unified-search a:active, a:hover, a:focus {
    color: white;
    background-color: orange;
}

.unified-search-resources {
    display: inline-block;
    vertical-align: top;
    min-width: 20%;
    cursor: pointer;
}

.unified-search-resources ul {
    padding:0;
    list-style-type: none;
    min-width: 35%;
}

.unified-search-filter {
    display: inline-block;
    vertical-align: top;
    min-width: 20%;
    cursor: pointer;
}

.unified-search-filter ul {
    list-style-type: none;
}

.unified-search-filter a {
    text-decoration: none;
}

.unified-search-filter a:visited a:active a:link a:hover  a:target {
    color: blue;
}

.unified-search-box {
    display: inline-block;
    vertical-align: top;
    padding-top: 1em;
}

.unified-search-box input {
    vertical-align: bottom;
    width: auto;
}

.unified-search-icon {
    vertical-align: top;
}

.more-tools {
    text-transform: capitalize;
    font-family: sans-serif;
    font-size: 0.84em;
}


/*
 * These are classes to attach visual behavoir
 */
.hidden {
    visible: none;
}

.visually-hidden {
    position: absolute !important;
    clip: rect(1px, 1px, 1px, 1px);
    padding: 0px !important;
    height: 1px !important;
    width: 1px !important;
    overflow: hidden;
}

.selected {
    color: white;
    background-color: orange;
}

.selected a:visited {
    color: white;
    background-color: orange;
}
  </style>
</head>
<body>
  <header><h1>prototype 1</h1></header>
  <section>
  <!-- START: Unified Search Box with JavaScript -->
  <div class="unified-search">
    <div class="unified-search-resources">
      <h1>Search</h1>
      <ul>
        <li><!-- START: EDS search options -->
            <a href="http://library.caltech.edu/index-eds.php" title="Articles, Books, etc." data-action="http://library.caltech.edu/index-eds.php" data-input-name="ebscohostsearchtext" data-hidden-fields="" data-placeholder="Search articles, books, etc.">Find It!</a>
        </li><!--  END: EDS search options -->
        <li><!-- START: Tind -->
            <a href="http://caltech.tind.io" title="Books and Print Journals" data-action="http://caltech.tind.io/search" data-input-name="p" data-hidden-fields="" data-placeholder="Search library catalog">Library Catalog</a>
            <ul>
                <li>
                    <a href="http://caltech.tind.io/search?f=title" data-action="http://caltech.tind.io/search" data-input-name="p" data-hidden-fields="f=title" data-placeholder="Search by title">Title</a>
                </li>
                <li>
                    <a href="http://caltech.tind.io/search?f=author" data-action="http://caltech.tind.io/search" data-input-name="p" data-hidden-fields="f=author" data-placeholder="Search by author">Author</a>
                </li>
                <li>
                    <a href="http://caltech.tind.io/search?f=subject" data-action="http://caltech.tind.io/search" data-input-name="p" data-hidden-fields="f=subject" data-placeholder="Search by subject">Subject</a>
                </li>
                <li>
                    <a href="http://caltech.tind.io/search?f=keyword" data-action="http://caltech.tind.io/search" data-input-name="p" data-hidden-fields="f=keyword" data-placeholder="Search by keyword">Keyword</a>
                </li>
                <li>
                    <a href="http://caltech.tind.io/search?f=isbn" data-action="http://caltech.tind.io/search" data-input-name="p" data-hidden-fields="f=isbn" data-placeholder="Search by ISBN">ISBN</a>
                </li>
                <li>
                    <a href="http://caltech.tind.io/search?f=journal" data-action="http://caltech.tind.io/search" data-input-name="p" data-hidden-fields="f=journal" data-placeholder="Search by journal">Journal</a>
                </li>
                <li>
                    <a href="http://caltech.tind.io/search?f=abstract" data-action="http://caltech.tind.io/search" data-input-name="p" data-hidden-fields="f=abstract" data-placeholder="Search by abstract">Abstract</a>
                </li>
                <li>
                    <a href="http://caltech.tind.io/search?f=issn" data-action="http://caltech.tind.io/search" data-input-name="p" data-hidden-fields="f=issn" data-placeholder="Search by issn">ISSN</a>
                </li>
            </ul>
        </li><!--  END: Tind -->
        <li><!-- START: SFX eJournal -->
            <a href="http://sfx.caltech.edu:8088/caltech/az" data-action="http://sfx.caltech.edu:8088/caltech/az" data-input-name="param_pattern_value" data-hidden-fields="param_perform_save=searchTitle" data-placeholder="Search Library eJournal subscriptions" title="Library eJournal subscriptions">Find eJournals</a>
        </li><!--  END: SFX eJournal -->
        <li><!-- START: Tind Course Reserves -->
            <a href="http://caltech.tind.io/search?c=Course%20Reserves" data-action="http://caltech.tind.io/search" data-input-name="p" data-hidden-fields="c=Course Reserves" data-placeholder="Search course reserves">Course Reserves</a>
            <ul>
                <!-- Course Reserves:
                Tind Web API Search Engine info: http://invenio-demo.cern.ch/help/hacking/search-engine-api
                + http://invenio-software.org/wiki/Talk/WebAPIs
                + http://demo.invenio-software.org/help/admin/howto-marc?ln=en
                + http://www.loc.gov/marc/bibliographic/

                 Indexed fields:
                 955 $$ a: Course Title
                 957 $$ a: Instructor
                 958 $$ a: Course Notes
                 959 $$ a: Semester
                 962 $$ t: Title of bibliographic record
                 962 $$ w: Bibliographic record ID

                Courses trying f=Course+Title to search for be something like tind101, cs08 -->
                <li><a href="http://caltech.tind.io/search?c=Course%20Reserves" data-action="http://caltech.tind.io/search" data-input-name="p" data-hidden-fields="c=Course%20Reserves" data-placeholder="By course name">Course</a></li>
                <li><a href="http://caltech.tind.io/search?c=Course%20Reserves&f=instructor" data-action="http://caltech.tind.io/search" data-input-name="p" data-hidden-fields="c=Course Reserves&amp;f=instructor" data-placeholder="By instructor name">Instructor</a></li>
            </ul>
        </li><!--  END: Tind Course Reserves -->
        <li><!-- START: CODA: Caltech Collections and Digital Archives -->
            <a href="https://cse.google.com/cse/publicurl?cx=005709273917748521174:b0g6d4sxowm&ie=UTF-8&q=CODA+-+Caltech+Collection+of+Open+Digital+Archives" data-action="https://cse.google.com/cse" data-input-name="q" data-hidden-fields="cx=005709273917748521174:b0g6d4sxowm&amp;ie=UTF-8" data-placeholder="Search Caltech’s Institutional Repository" title="Caltech’s Institutional Repository">CODA: Caltech Collections and Digital Archives</a>
        </li><!--  END: CODA: Caltech Collections and Digital Archives -->
        <li><!-- START: Website --  </li><!--  END: Website -->
        <li><!-- START: More search tools -->
            (<a class="more-tools"="http://libguides.caltech.edu/">More search tools</a>)
            </li>
      </ul><!--END .unified-search-resources -->
    </div>
    <div class="unified-search-filter"></div>
    <div class="unified-search-box">
      <form method="get" action="http://clas.library.caltech.edu/">
        <!--NOTE: JavaScript will replace the input name based on the menu item selected. Needs to have a class of unified-query-box -->
        <input id="unified-query-box" type="text" name="search" value="" placeholder="Search for...">
        <button type="submit"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="12" height="16" viewBox="0 0 12 12" aria-hidden="true" class="unified-search-icon">
    			<path d="M7.273 0.727q1.187 0 2.19 0.585t1.588 1.588 0.585 2.19-0.585 2.19-1.588 1.588-2.19 0.585q-1.278 0-2.33-0.676l-3.284 3.301q-0.295 0.284-0.688 0.284-0.403 0-0.688-0.284t-0.284-0.688 0.284-0.688l3.301-3.284q-0.676-1.051-0.676-2.33 0-1.188 0.585-2.19t1.588-1.588 2.19-0.585zM7.273 8q0.591 0 1.128-0.23t0.929-0.622 0.622-0.929 0.23-1.128-0.23-1.128-0.622-0.929-0.929-0.622-1.128-0.23-1.128 0.23-0.929 0.622-0.622 0.929-0.23 1.128 0.23 1.128 0.622 0.929 0.929 0.622 1.128 0.23z"></path>
    		</svg></button>
      </form>
    </div>
  </div><!--END .unified-search -->
  <div>
  <h3>Notes</h3>
  <p>&quot;Find It&quot; and &quot;Course Reserves&quot; are not fully functional. I am still doing research on the APIs for Tind and EBSCO.</p>
  </div>
  </section>
  <script><!--  START: Unified Search Box behaviors -->
/**
 * search.js - embed a unified search component for the Caltech library.
 * Inspiration was MIT Library's search (source repository: https://github.com/mitlibraries-ux/MITlibraries-parent/blob/prod/js/search.js)
 *
 * @author R. S. Doiel, <rsdoiel@caltech.edu>
 */
 (function (document, window) {
     "use strict";
     var menuElements = {},
        i = 0,
        currentElement = null,
        filterUL = null,
        unifiedSearch = document.querySelector(".unified-search") || null,
        unifiedSearchFilter = document.querySelector(".unified-search-filter") || null,
        unifiedSearchForm = unifiedSearch.querySelector(".unified-search-box form") || null;

     function setVisibility(element, visible) {
         // If JavaScript is enabled then display the JavaScript dependent form.
         if (visible === "visible" && element.className != undefined && element.className.indexOf("hidden") > -1) {
            element.className = element.className.replace("hidden", "").trim();
         } else {
            element.className = (element.className + " hidden").trim();
         }
     }

     function selectMenuItem(label) {
         var labels = Object.keys(menuElements);
         labels.forEach(function (k,i) {
             var item = menuElements[k];
             if (item.element.className.indexOf("selected") > -1) {
                 item.element.className = item.element.className.replace("selected", "").trim();
             }
             if (k == label) {
                 item.element.className = (item.element.className + " selected").trim();
             }
         })
     }

     function selectFilterItem(element) {
        var filterLIs = document.querySelectorAll(".unified-search-filter a"),
        i = 0;
        console.log("DEBUG element type? "+element.textContent);
        if (filterLIs !== null) {
            for (i = 0; i < filterLIs.length; i  += 1) {
                if (filterLIs[i].className.indexOf("selected") > -1) {
                    filterLIs[i].className = filterLIs[i].className.replace("selected", "").trim();
                }
            }
        }
        element.className = (element.className + " selected").trim();
     }

     // Detaches the selected node and returns the detacted node.
     function detachChildElement(element, selector) {
         var child = element.querySelector(selector);
         if (child == null) {
             return null;
         }
         return element.removeChild(child);
     }

    function menuFilterHandler(evt) {
        var element = evt.currentTarget,
        action = "",
        label = "",
        placeholder = "",
        hidden = "",
        hidden_fields = {},
        parts = [],
        label = element.textContent.trim(),
        inputName = "",
        queryBox = document.getElementById("unified-query-box");

        selectFilterItem(element);
        evt.preventDefault();
        label = element.textContent;

        inputName = element.getAttribute("data-input-name");
        if (inputName !== null) {
            queryBox.setAttribute("name", inputName);
        }
        placeholder = element.getAttribute("data-placeholder");
        if (placeholder !== null) {
            queryBox.setAttribute("placeholder", placeholder);
        }

        action = element.getAttribute("data-action");
        if (action != null) {
            unifiedSearchForm.setAttribute("action", action);
        }
        hidden = element.getAttribute("data-hidden-fields");
        if (hidden != null) {
            if (hidden.indexOf("&") > -1) {
                parts = hidden.split("&");
                parts.forEach(function (item, i) {
                    var kv = item.split("=", 2);
                    hidden_fields[decodeURI(kv[0])] = decodeURI(kv[1]);
                });
            } else {
                parts = hidden.split("=", 2);
                hidden_fields[decodeURI(parts[0])] = decodeURI(parts[1]);
            }
            // Add the fields to the existing search form.
            Object.keys(hidden_fields).forEach(function (k, i) {
                // Check if the field exists, add it if needed otherwise
                // update the value
                var child = unifiedSearchForm.querySelector("input[name=" + k + "]");
                if (child == null) {
                    child = document.createElement("input");
                }
                child.setAttribute("type", "hidden");
                child.setAttribute("name", k);
                child.setAttribute("value", hidden_fields[k]);
                unifiedSearchForm.appendChild(child);
            });
        }/* end of if (hidden !== null) */
    }

     function menuResourceHandler(evt) {
         var element = evt.currentTarget,
            label = element.textContent,
            menuItem = menuElements[label],
            queryBox = document.getElementById("unified-query-box"),
            child = null;

         evt.preventDefault();

         if (menuItem !== undefined) {
             selectMenuItem(label);
             detachChildElement(unifiedSearchFilter, "UL");
             if (menuItem.ul !== null) {
                 unifiedSearchFilter.innerHTML = "<h1>By</h1>";
                 //FIXME: need to remove any stale selected attribute from element before display
                 unifiedSearchFilter.appendChild(menuItem.ul);
             } else {
                 unifiedSearchFilter.innerHTML = "";
             }
             // Update Action and method
             unifiedSearchForm.setAttribute("action", menuItem.action);
             unifiedSearchForm.setAttribute("method", menuItem.method);
             // Remove any stale hidden fields
             do {
                 child = detachChildElement(unifiedSearchForm, "input[type=hidden]");
             }  while (child != null);
             // Add any additional hidden fields needed
             Object.keys(menuItem.hidden_fields).forEach(function(field, i) {
                 var child = document.createElement("input");
                 child.setAttribute("type", "hidden");
                 child.setAttribute("name", field);
                 child.setAttribute("value", menuItem.hidden_fields[field]);
                 unifiedSearchForm.appendChild(child);
             })

             queryBox.setAttribute("name", menuItem.inputName)
             queryBox.setAttribute("placeholder", menuItem.placeholder);
             setVisibility(unifiedSearchFilter, "visible");
         }
     }

     function attachFilterHandlers(ul) {
        var anchors = null,
            i = 0;
        if (ul !== null) {
            anchors = ul.querySelectorAll("a");
            for (i = 0; i < anchors.length; i += 1) {
                if (anchors[i].getAttribute("data-action") || anchors[i].getAttribute("data-hidden-fields")) {
                    anchors[i].addEventListener('click', menuFilterHandler, false);
                }
            }
        }
     }

     function makeMenuElement(element) {
         var anchor = element.querySelector("A"),
            label = "",
            method = "GET",
            action = "",
            placeholder = "",
            inputName = "",
            ul = null,
            parts = [],
            hidden_fields = {},
            hidden = "",
            k = "",
            v = "";

        if (anchor !== null) {
            label = anchor.textContent || "";
            method = anchor.getAttribute("data-method") || "GET";
            action = anchor.getAttribute("data-action") || "";
            placeholder = anchor.getAttribute("data-placeholder") || "";
            inputName = anchor.getAttribute("data-input-name") || "";
            hidden = anchor.getAttribute("data-hidden-fields") || "";

            if (action !== "") {
                anchor.addEventListener('click', menuResourceHandler, false);
                anchor.addEventListener('focus', menuResourceHandler, false);
                ul = detachChildElement(element, "UL");
                attachFilterHandlers(ul);
                if (hidden.trim() !== "") {
                    if (hidden.indexOf("&") > -1) {
                        parts = hidden.split("&");
                        parts.forEach(function (item, i) {
                            var kv = item.split("="),
                                k = decodeURI(kv[0]),
                                v = decodeURI(kv[1]);
                            if (k != inputName) {
                                hidden_fields[k] = v;
                            }
                        });
                    } else if (hidden.indexOf("&") > -1) {
                        parts = hidden.split("=");
                        k = decodeURI(parts[0]);
                        v = decodeURI(parts[1]);
                        hidden_fields[k] = v;
                    }
                }
            }
            menuElements[label] = {
                 label: label,
                 element: element,
                 method: method,
                 action: action,
                 hidden_fields: hidden_fields,
                 inputName: inputName,
                 placeholder:placeholder,
                 ul: ul
            };
        }/* end if (anchor !== null) */
     }


     //
     // Main processing for unified search box
     //

     // Validate box structure as one we know how to work with.
     //FIXME: Need to implement some sort of validation so that box can be managed via HTML only.
     // Make the search stuff hidden while we're building the new page functionality.
     setVisibility(unifiedSearch, "hidden");
     // Build a menu list and re-arrange things.
     currentElement = unifiedSearch.querySelector(".unified-search-resources li") || null;
     while (currentElement != null) {
         if (currentElement.nodeName === "LI") {
             makeMenuElement(currentElement);
         }
         currentElement = currentElement.nextSibling;
     }

     // We should be ready to go so, make the unified search box visible!
     setVisibility(unifiedSearch, "visible");
 }(document, window));
  </script><!--  END: Unified Search Box behaviors -->
  <nav>
    <h2>project prototypes</h2>
    <ul>
      <li><a href="index.html">home</a></li>
      <li><a href="prototype1.html">prototype 1</a> a UL list as datastructure describing hetrogenious search forms</li>
      <li><a href="prototype2.html">prototype 2</a> a more traditional element implementation</li>
      <li><a href="prototype3.html">prototype 3</a> using the EDS form API</li>
      <li><a href="prototype4.html">prototype 4</a> getting tab and focus working</li>
      <li><a href="prototype5.html">prototype 5</a> another step towards a unified search box</li>
    </ul>
  </nav>
  <footer>No droids, here. We're of no interest. Move along.</footer>
</body>
</html>
