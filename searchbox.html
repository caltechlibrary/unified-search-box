<!--START: include css/usb.css -->
<style>
/**
 * usb.css - the design for the Unified Search Box.
 */
.hide {
    display: none;
    visibility: hidden;
}

.usb-searchbox {
    display: block;
    position: relative;
    padding: 1.0em;
    color: black;
    background-color: white;
}

.usb-search-resources {
    position: relative;
    display: inline-flex;
    margin: 0.24em;
    width: 30%;
}

.usb-search-resources label {
    position: relative;
    display: inline-flex;
    width: auto;
    height: 3.0em;
    padding: 0.24em;
    text-align: right;
}

.usb-search-resources div {
    position: relative;
    display: inline-flex;
    width: 92%;
    height: 3.0em;
    padding: 0.24em;
}

.usb-search-filters {
    position: relative;
    display: inline-flex;
    margin: 0.24em;
    width: 25%;
}

.usb-search-filters label {
    position: relative;
    display: inline-flex;
    width: auto;
    height: 3.0em;
    padding: 0.24em;
    text-align: right;
}

.usb-search-filters div {
    position: relative;
    display: inline-flex;
    width: 92%;
    height: 3.0em;
    padding: 0.24em;
}

.usb-menu {
    position: relative;
    margin-left: 0.52em;
    min-width: 20%;
    height: auto;
    font-size: 1.0em;
    color: black;
    background-color: #EEF2FB;
    border-radius: 0.48em;
}

.usb-menu ul {
    position: absolute;
    display: none;
    top: 1.24em;
    left: 0;
    list-style: none;
    margin: 2.72em;
    padding: 0.24em;
    z-index: 10;
    /* border: 0.24em solid blue; */
    border: 1px solid white;
    background-color: inherit;
    box-shadow: 0.12em 0.12em #043584;
}

.usb-menu ul li {
    border-bottom: 0.12em solid #043584;
    padding: 0.42em;
}

.usb-menu-item-selected, .usb-menu-item-selected span, .usb-menu-item-selected a, .usb-menu-item-selected a:link, .usb-menu-item-selected a:visited {
    background-color: lightgrey;
}


.usb-menu ul li:last-child {
    border-bottom: none;
}

.usb-menu-selected {
    position: relative;
    display: inline-flex;
    padding-left: 0.24em;
}

.usb-menu-select-button {
    position: relative;
    display: inline-flex;
    width: 1.24em;
}

.usb-menu-select-button svg {
    position: relative;
    display: inline-flex;
    padding: 0.24em;
    width: 1.24em;
    height: 1.24em;
    fill: darkblue;
}

.usb-menu-label {
    display: inline-block;
    position: relative;
}

.usb-menu-item-primary {
    display: block;
    font-weight: bold;
    text-transform: none;
    text-align: left;
}

.usb-menu-item-primary a, .usb-menu-item-primary a:link, .usb-menu-item-primary a:active {
    text-decoration: none;
    color: black;
    background-color: #EEF2FB;
}

.usb-menu-item-primary a:hover, .usb-menu-item-primary a:focus, .usb-menu-item-secondary a:visited {
    text-decoration: none;
    color: white;
    background-color: #043584;
}

.usb-menu-item-secondary {
    display: block;
    font-weight: lighter;
    text-transform: none;
    text-decoration: none;
    text-align: left;
}

.usb-search-query {
    position: relative;
    display: inline-flex;
}

.usb-query-label {
    margin-right: 0.52em;
    width: auto;
    height: 2em;
    padding: 0.24em;
}

.usb-query-input {
    display: inline-flex;
    position: relative;
    min-width: 20%;
    max-width: 60%;
}

.usb-query-input > .usb-menu-label {
    padding: 1.52em;
}

.usb-query-input > form {
    position: relative;
    display: inline-flex;
    height: 2em;
    padding-left: 1.52em;
}

.usb-query-input > form > input {
    position: relative;
    display: inline-flex;
    font-size: 0.8em;
    height: 2.0em; /* for IE */
    vertical-align: middle; /* This is optional but it makes legacy IEs look better */
}

 .usb-query-input > form > button {
    position: relative;
    display: inline-flex;
}

.usb-query-input > form > button > svg {
    height: 2.42em;
    width: 2.42em;
}

.usb-more-search-tools {
    position: absolute;
    display: inline-flex;
    top: 2.72em;
    left: 33%;
    width: 100%;
    height: 2em;
    padding: 0.24em;
    text-align: center;
}

.usb-more-search-tools a {
    color: darkblue;
}
</style>
<!--   END: css/usb.css -->

<!-- START: html fragment searchbox -->

  <div id="usb-searchbox" class="usb-searchbox">
    <div class="usb-search-resources">
        <label class="usb-menu-label">Search</label>
        <div id="usb-search-resources" class="usb-menu">
            <div id="usb-resource-menu-selected" class="usb-menu-selected">Cross database search</div>
            <a href="#" tabindex="1" class="usb-menu-select-button"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="8.071px" height="14px" viewBox="0 0 8.071 14" enable-background="new 0 0 8.071 14" xml:space="preserve">
                <path d="M0.069 8.74c0.08-0.159 0.252-0.264 0.436-0.274 0.023 0 1.743-0.104 3.531-0.104s3.508 0.104 3.53 0.104C7.751 8.476 7.911 8.581 8.003 8.74c0.092 0.161 0.092 0.356 0 0.517 -1.364 2.431-3.508 4.517-3.6 4.598 -0.206 0.194-0.528 0.194-0.734 0 -0.091-0.081-2.235-2.167-3.6-4.598C-0.023 9.096-0.023 8.901 0.069 8.74M8.003 5.259c-0.08 0.16-0.252 0.264-0.437 0.275 -0.022 0-1.742 0.103-3.53 0.103S0.528 5.535 0.505 5.535C0.321 5.523 0.161 5.419 0.069 5.259c-0.092-0.161-0.092-0.355 0-0.516 1.365-2.431 3.508-4.517 3.6-4.598 0.206-0.194 0.528-0.194 0.734 0 0.092 0.081 2.235 2.167 3.6 4.598C8.095 4.904 8.095 5.099 8.003 5.259"></path>
            </svg></a>
            <ul>
                <li><span class="usb-menu-item-primary"><a id="eds" href="#">Cross database search</a></span> <span class="usb-menu-item-secondary">Articles, Books, etc.</span></li>
                <li><span class="usb-menu-item-primary"><a id="tind" href="#">Library Catalog</a></span> <span class="usb-menu-item-secondary">Books and Print Journals</span></li>
                <li><span class="usb-menu-item-primary"><a id="sfx" href="#">Find eJournals</a></span> <span class="usb-menu-item-secondary">Library eJournal Subscriptions</span></li>
                <li><span class="usb-menu-item-primary"><a id="tindCourseReserves" href="#">Course Reserves</a></span></li>
                <li><span class="usb-menu-item-primary"><a id="coda" href="#">CODA: Caltech Collection of Digital Archives</a></span> <span class="usb-menu-item-secondary">Caltech's Institutional Repository</span></li>
                <li><span class="usb-menu-item-primary"><a id="archivalImages" href="#">Images</a></span> <span class="usb-menu-item-secondary">Caltech Archives</span></li>
                <li><span class="usb-menu-item-primary"><a id="archivalMaterial" href="#">Archival materials</a></span> <span class="usb-menu-item-secondary">Caltech Archives</span></li>
                <li><span class="usb-menu-item-primary"><a id="website" href="#">Search Website</a></span> <span class="usb-menu-item-secondary">Library website and LibGuides</span></li>
            </ul>
        </div><!-- END: id="usb-search-resources" -->
    </div><!-- END: class="usb-search-resources" -->

    <div id="usb-search-filters" class="usb-search-filters">
        <label id="usb-filter-label" class="usb-menu-label">By</label>
        <div id="usb-filter" class="usb-menu">
            <div id="usb-filter-menu-selected" class="usb-menu-selected"></div>
            <a href="#" tabindex="1" class="usb-menu-select-button"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="8.071px" height="14px" viewBox="0 0 8.071 14" enable-background="new 0 0 8.071 14" xml:space="preserve">
                <path d="M0.069 8.74c0.08-0.159 0.252-0.264 0.436-0.274 0.023 0 1.743-0.104 3.531-0.104s3.508 0.104 3.53 0.104C7.751 8.476 7.911 8.581 8.003 8.74c0.092 0.161 0.092 0.356 0 0.517 -1.364 2.431-3.508 4.517-3.6 4.598 -0.206 0.194-0.528 0.194-0.734 0 -0.091-0.081-2.235-2.167-3.6-4.598C-0.023 9.096-0.023 8.901 0.069 8.74M8.003 5.259c-0.08 0.16-0.252 0.264-0.437 0.275 -0.022 0-1.742 0.103-3.53 0.103S0.528 5.535 0.505 5.535C0.321 5.523 0.161 5.419 0.069 5.259c-0.092-0.161-0.092-0.355 0-0.516 1.365-2.431 3.508-4.517 3.6-4.598 0.206-0.194 0.528-0.194 0.734 0 0.092 0.081 2.235 2.167 3.6 4.598C8.095 4.904 8.095 5.099 8.003 5.259"></path>
            </svg></a>
            <ul id="usb-filter-ul">
                <!-- EXAMPLE LI: <li><span class="usb-menu-item-primary"><a href="#" class="usb-menu-item-selected">Filter Item</a></span></li> -->
            </ul>
        </div><!-- END: id="usb-search-filters" -->
    </div><!-- END: class="usb-search-filters" -->

    <div class="usb-search-query">
        <div class="usb-query-label">For</div>
        <div class="usb-query-input">
            <form id="usb-query-form">
                <input id="usb-query-input" type="search" size="42">
                <button><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="12" height="16" viewBox="0 0 12 12" aria-hidden="true" class="icon-search">
                        <path d="M7.273 0.727q1.187 0 2.19 0.585t1.588 1.588 0.585 2.19-0.585 2.19-1.588 1.588-2.19 0.585q-1.278 0-2.33-0.676l-3.284 3.301q-0.295 0.284-0.688 0.284-0.403 0-0.688-0.284t-0.284-0.688 0.284-0.688l3.301-3.284q-0.676-1.051-0.676-2.33 0-1.188 0.585-2.19t1.588-1.588 2.19-0.585zM7.273 8q0.591 0 1.128-0.23t0.929-0.622 0.622-0.929 0.23-1.128-0.23-1.128-0.622-0.929-0.929-0.622-1.128-0.23-1.128 0.23-0.929 0.622-0.622 0.929-0.23 1.128 0.23 1.128 0.622 0.929 0.929 0.622 1.128 0.23z"></path>
                </svg></button>
            </form><!-- END: id="usb-query-form" -->
        </div><!-- END: class="usb-query-input" -->
        <div class="usb-more-search-tools">
        (<a href="http://libguides.caltech.edu/">More search tools</a>)
        </div>
    </div><!-- END: class="usb-search-query-form" -->
  </div><!-- END: id="usb-searchbox" -->
<!--   END: html fragment searchbox -->

<!-- START: js/usb.js -->
<script>
/**
 * usb.js - Unified Search Box behaviors.
 */
/*jslint browser: true */
(function (doc) {
    "use strict";
    var resources = doc.getElementById("usb-search-resources"),
        resourcesSelectButton = resources.querySelector(".usb-menu-select-button"),
        resourcesMenuItems = resources.querySelectorAll(".usb-menu-item-primary a"),
        filtersContainer = doc.getElementById("usb-search-filters"),
        filters = doc.getElementById("usb-filter"),
        filtersUL = doc.getElementById("usb-filter-ul"),
        filtersSelectButton = filters.querySelector(".usb-menu-select-button"),
        filtersMenuItems = filters.querySelectorAll(".usb-menu-item-primary a"),
        searchQueryForm = doc.getElementById("usb-query-form"),
        searchQueryInput = doc.getElementById("usb-query-input"),
        resourceId = "eds",
    /**
     * model the search engines options and form implementations
         <!--
          SEARCH TARGET | LABEL | DESCRIPTION
          --------------|-------|------------------
          * EDS           | Find It | Articles, Books, etc.
          --------------|-------|------------------
          TIND          | Library Catalog | Books and Print Journals
          --------------|-------|------------------
          SFX           | Find eJournals | Library Ejournal subscriptions
          --------------|-------|------------------
          TIND          | Course Reserves |
          --------------|-------|------------------
          Google Custom Search | CODA: Caltech Collection of Digital Archives | Caltech’s Institutional Repository
          --------------|-------|------------------
          Google Custom Search | Website search | Library website and LibGuides
          --------------|-------|------------------
          Link to web page | More search tools and Help |
          --------------|-------|------------------
          islandora     | Image Archives |
        -->
     */
        searchWidget = {
            "eds": {
                script: [{src: "http://support.ebscohost.com/eit/scripts/ebscohostsearch.js", type: "text/javascript"}],
                filter: [],
                form: {
                    method: "GET",
                    action: "",
                    onSubmit: "return ebscoHostSearchGo(this);",
                    input: [
                        {id: "ebscohostwindow", name: "ebscohostwindow", type: "hidden", value: "0"},
                        {id: "ebscohosturl", name: "ebscohosturl", type: "hidden", value: "https://clsproxy.library.caltech.edu/login?url=http://search.ebscohost.com/login.aspx?direct=true&site=eds-live&scope=site&type=0&custid=s8984125&groupid=main&profid=eds&mode=bool&lang=en&authtype=ip"},
                        {id: "ebscohostsearchsrc", name: "ebscohostsearchsrc", type: "hidden", value: "db"},
                        {id: "ebscohostsearchmode", name: "ebscohostsearchmode", type: "hidden", value: "+"},
                        {id: "ebscohostkeywords", name: "ebscohostkeywords", type: "hidden", value: ""},
                        {id: "ebscohostsearchtext", name: "ebscohostsearchtext", type: "text", value: "", placeholder: "Search Articles, Books, etc.", size: 64, maxlength: 128}
                    ]
                }
            },
            "tind": {
                filter: [
                    {
                        label: "Title",
                        input: {name: "f", value: "title", "type": "hidden"}
                    },
                    {
                        label: "Author",
                        input: {name: "f", value: "author", "type": "hidden"}
                    },
                    {
                        label: "Subject",
                        input: {name: "f", value: "subject", "type": "hidden"}
                    },
                    {
                        label: "Keyword",
                        input: {name: "f", value: "keyword", "type": "hidden"}
                    },
                    {
                        label: "ISBN",
                        input: {name: "f", value: "isbn", "type": "hidden"}
                    },
                    {
                        label: "Journal",
                        input: {name: "f", value: "journal", "type": "hidden"}
                    },
                    {
                        label: "Abstract",
                        input: {name: "f", value: "abstract", "type": "hidden"}
                    },
                    {
                        label: "ISSN",
                        input: {name: "f", value: "issn", "type": "hidden"}
                    }
                ],
                form: {
                    method: "GET",
                    action: "https://caltech.tind.io/search",
                    input: [
                        {name: "ln", value: "en", "type": "hidden"},
                        {name: "c", value: "Caltech", "type": "hidden"},
                        {name: "action_search", value: "Search", "type": "hidden"},
                        {name: "p", value: "", placeholder: "Search library catalog", "type": "search", size: 64, maxlength: 128}
                    ]
                }
            },
            "sfx": {
                filter: [],
                form: {
                    method: "GET",
                    action: "http://sfx.caltech.edu:8088/caltech/az",
                    input: [
                        {name: "param_perform_save", value: "searchTitle", "type": "hidden"},
                        {name: "param_pattern_value", value: "", placeholder: "Library eJournal subscriptions", "type": "search", size: 64, maxlength: 128}
                    ]
                }
            },
            "tindCourseReserves": {
                filter: [
                    {
                        label: "Course",
                        input: {name: "f", value: "coursereserve", "type": "hidden"}
                    },
                    {
                        label: "Instructor",
                        input: {name: "f", value: "", "type": "hidden"}
                    }
                ],
                form: {
                    method: "GET",
                    action: "https://caltech.tind.io/search",
                    input: [
                        {name: "ln", value: "en", "type": "hidden"},
                        {name: "cc", value: "Course Reserves", "type": "hidden"},
                        {name: "action_search", value: "Search", "type": "hidden"},
                        {name: "p", value: "", placeholder: "Search Course Reserves", "type": "search", size: 64, maxlength: 128}
                    ]
                }
            },
            "coda": {
                filter: [],
                form: {
                    method: "GET",
                    action: "https://cse.google.com/cse/publicurl",
                    input: [
                        {name: "cx", value: "005709273917748521174:b0g6d4sxowm", "type": "hidden"},
                        {name: "ie", value: "UTF-8", "type": "hidden"},
                        {name: "q", value: "", placeholder: "Search Caltech’s Institutional Repository", "type": "search", size: 64, maxlength: 128}
                    ]
                }
            },
            "archivalImages": {
                filter: [],
                form: {
                    method: "POST",
                    action: "http://archives-dc.library.caltech.edu/",
                    /*NOTES: Copied from the embedded search form on the archives' homepage.

                    <form action="/" method="post" id="islandora-solr-simple-search-form" accept-charset="UTF-8">
                        <div>
                            <div class="container-inline form-wrapper" id="edit-simple">
                                <div class="form-item form-type-textfield form-item-islandora-simple-search-query">
                                    <input type="text" id="edit-islandora-simple-search-query" name="islandora_simple_search_query" value="" size="15" maxlength="128" class="form-text" />
                                </div>
                                <input type="submit" id="edit-submit" name="op" value="search" class="form-submit" />
                            </div>
                            <input type="hidden" name="form_build_id" value="form-K83NaIRvMxcPkpUaVFu2yrlvZZQ6fYd3oiET4bj-ZpY" />
                            <input type="hidden" name="form_id" value="islandora_solr_simple_search_form" />
                        </div
                   ></form>
                   */
                    input: [
                        {name: "form_build_id", value: "form-K83NaIRvMxcPkpUaVFu2yrlvZZQ6fYd3oiET4bj-ZpY", "type": "hidden"},
                        {name: "form_id", value: "islandora_solr_simple_search_form", "type": "hidden"},
                        {name: "islandora_simple_search_query", type: "text", value:"", placeholder: "Search Caltech’s Image Archives", size: 64, maxlength: 128}
                    ]
                }
            },
            "archivalMaterial": {
                filter: [],
                form: {
                    method: "GET",
                    action: "http://www.oac.cdlib.org/search",
                    input: [
                        {name: "x", value: "0", "type": "hidden"},
                        {name: "y", value: "0", "type": "hidden"},
                        {name: "institution", value: "California Institute of Technology", "type": "hidden"},
                        {name: "query", value: "", placeholder: "Search Caltech Archives", "type": "search", size: 64, maxlength: 128}
                    ]
                }
            },
            "website": {
                filter: [],
                form: {
                    method: "GET",
                    action: "http://google.com/cse",
                    input: [
                        {type: "hidden", name: "cx", value: "005709273917748521174:po9fevg5ksw", "type": "hidden"},
                        {type: "hidden", name: "ie", value: "UTF-8", "type": "hidden"},
                        {type: "text", name: "q", maxlength: "255", value: "", placeholder: "Search library website"}
                    ]
                }
            }
        };

    function addClass(elem, className) {
        var currentClasses = elem.className || "";
        if (currentClasses.indexOf(className) === -1) {
            elem.className = (currentClasses + " " + className).trim();
        }
    }

    function removeClass(elem, className) {
        var currentClasses = elem.className || "";
        if (currentClasses.indexOf(className) !== -1) {
            elem.className = currentClasses.replace(className, "").replace("  ", " ");
        }
    }

    function hideFilters(state) {
        if (state === true) {
            addClass(filtersContainer, "hide");
        } else {
            removeClass(filtersContainer, "hide");
        }
    }

    function getParentOfTagName(elem, tagName) {
        // Walk up to the parent of the UL.
        var cur = elem, prev = null;
        while (cur !== null) {
            prev = cur;
            cur = prev.parentNode;
            if (prev.tagName === tagName) {
                break;
            }
        }
        return cur;
    }

    function toggleMenu(element) {
        var ul = element.getElementsByTagName('ul').item(0);

        if (ul.getAttribute('style') === "display:inline-block;") {
            ul.setAttribute('style', 'display:none;');
        } else {
            ul.setAttribute('style', 'display:inline-block;');
        }
    }

    /**
     * menuEventHandler - toggles the menu visibility as necessary
     * @param ev - the event trigger.
     */
    function menuEventHandler(ev) {
        var elem = ev.target;
        // we don't use getParentOfTagName() here since we're already in a set of nested divs here.
        if (elem !== null) {
            switch (elem.tagName.toLowerCase()) {
            case 'a':
                toggleMenu(elem.parentNode);
                break;
            case 'path':
                toggleMenu(elem.parentNode.parentNode.parentNode);
                break;
            default:
                toggleMenu(elem.parentNode.parentNode);
                break;
            }
        }
    }

    /**
     * clearQueryForm - reset the form with id equal usb-query-form to an
     * empty form withput any input elements.
     * @param form the element with id equal to usb-query-form
     */
    function clearQueryForm(form) {
        var inputs = form.querySelectorAll("input"),
            i = 0;
        for (i = 0; i < inputs.length; i += 1) {
            if (inputs[i].id === undefined || inputs[i].id !== 'usb-query-input') {
                form.removeChild(inputs[i]);
            }
        }
    }

    /**
     * clearFilterMenu() - remove any li, spans and anchors in the UL list as well
     * as any listeners.
     * @param ul - the ul element containg the li, spans and anchors to be cleared.
     */
    function clearFilterMenu(ul, eventListener) {
        var anchors = ul.querySelectorAll("a") || [],
            li = ul.querySelectorAll("li") || [],
            i = 0;

        for (i = 0; i < anchors.length; i += 1) {
            anchors[i].removeEventListener("click", eventListener);
        }
        for (i = 0; i < li.length; i += 1) {
            ul.removeChild(li[i]);
        }
    }


    /**
     * updateFilterMenu - updates the filter menu based on what resource was selected.
     * @param searchWidget data structure describing the relationship from resource to filters and input form
     * @param ul the ul element which will contain an filters for the resource
     * @param form the form element with id equal udb-query-form
     * @param resourceId a string to use to locate the resource in searchWidget data structure.
     * @param eventListener the event listener needs to be removed before removing the child to avoid memory leaks.
     */
    function updateFilterMenu(searchWidget, ul, form, resourceId, eventListener) {
        var resource = searchWidget[resourceId] || null,
            filterMenuSelected = doc.getElementById('usb-filter-menu-selected') || null,
            liTemplate = '<span class="usb-menu-item-primary"><a href="#">{{label}}</a></span>';

        clearFilterMenu(ul, eventListener);
        //FIXME: Update the filter UL list
        if (resource.filter === undefined || resource.filter.length === 0) {
            hideFilters(true);
        } else {
            hideFilters(false);
            resource.filter.forEach(function (obj, i) {
                var li = doc.createElement("li"),
                    a = null;
                li.innerHTML = liTemplate.replace("{{label}}", obj.label);
                if (i === 0) {
                    li.className = "usb-menu-item-selected";
                    if (filterMenuSelected !== null) {
                        filterMenuSelected.textContent = obj.label;
                    }
                }
                a = li.querySelector("a");
                //FIXME: Add new listeners UL
                if (a !== null) {
                    //FIXME: Adjust query form if necessary
                    //FIXME: The event listener will need to add/update input fields to the form when selected.
                    a.addEventListener("click", eventListener);
                }
                ul.appendChild(li);
            });
        }
    }

    /**
     * updateQueryForm - setup the input fields (including hidden ones) based
     * on the resource picked. It should remove any previously used input elements
     * as well as any listeners attached before adding the new input elements needed.
     * @param searchWidget data structure describing the relationship from resource to filters and input form
     * @param formElement the form element with the id of usb-query-form
     * @param resourceId a string to use to locate the resource in searchWidget data structure.
     * @param addFilterInputs - if true add the filster inputs
     */
    function updateQueryForm(searchWidget, formElement, resourceId) {
        var resource = searchWidget[resourceId],
            form = resource.form,
            inputs = form.input,
            i = 0,
            elem = null;

        clearQueryForm(formElement);
        formElement.setAttribute("method", form.method);
        formElement.setAttribute("action", form.action);

        for (i = 0; i < inputs.length; i += 1) {
            if (inputs[i].type === "search" || inputs[i].type === "text") {
                searchQueryInput.setAttribute("name", inputs[i].name);
                searchQueryInput.setAttribute("type", inputs[i].type);
                //FIXME: Tind will want values quoted in some cases e.g. course names like "Ge 101"
                searchQueryInput.setAttribute("value", inputs[i].value);
                searchQueryInput.setAttribute("placeholder", inputs[i].placeholder);
            } else {
                elem = doc.createElement("input");
                elem.setAttribute("type", inputs[i].type);
                elem.setAttribute("name", inputs[i].name);
                elem.setAttribute("value", inputs[i].value);
                searchQueryForm.appendChild(elem);
            }
        }
        if (form.onSubmit !== undefined) {
            formElement.setAttribute("onSubmit", form.onSubmit);
        } else if (formElement.hasAttribute("onSubmit") === true) {
            formElement.removeAttribute("onsubmit");
        }
    }

    /**
     * setHiddenInputField() - the hidden input element associated with filter selected
     * @param searchWidget data structure describing the relationship from resource to filters and input form
     * @param resourceId a string to use to locate the resource in searchWidget data structure.
     * @param label the string to used as a label in the fitler list object
     */
    function setHiddenInputField(searchWidget, resourceId, label) {
        var resource = searchWidget[resourceId],
            filter = resource.filter,
            i = 0,
            foundIt = false,
            elem = null;
        for (i = 0; i < filter.length && foundIt === false; i += 1) {
            if (filter[i].label === label) {
                foundIt = true;
                elem = searchQueryForm.querySelector("input[name="+filter[i].input.name+"]");
                if (elem !== null) {
                    elem.type = filter[i].input.type;
                    elem.name = filter[i].input.name;
                    elem.value = filter[i].input.value;
                } else {
                    elem = doc.createElement("input");
                    elem.setAttribute("type", filter[i].input.type);
                    elem.setAttribute("name", filter[i].input.name);
                    elem.setAttribute("value", filter[i].input.value);
                    searchQueryForm.appendChild(elem);
                }
            }
        }
    }

    /**
     * addMenuItemListener() - add a handler listing for eventName
     * @param elem - the menu item element
     * @param eventName - the string name of the event to listen for (e.g. click)
     * @param listerner the event handler for that event.
     * @param useCapture - pass through the useCapture flag for attached listener.
     */
    function addMenuItemListener(elem, eventName, listener, useCapture) {
        elem.addEventListener(eventName, listener, useCapture);
    }

    /**
     * filtersEventHandler() - handle menu item level events. Rerender the
     * unified search box as appropriate.
     * @param ev the event the resource menu is listening for.
     */
    function filtersEventHandler(ev) {
        var elem = ev.target,
            cur = getParentOfTagName(elem, "UL"),
            menuSelected = cur.querySelector(".usb-menu-selected"),
            previouslySelected = cur.querySelector(".usb-menu-item-selected"),
            resources = doc.getElementById("usb-search-resources"),
            resourceSelected = resources.querySelector("li.usb-menu-item-selected") || null,
            resourceId = "",
            resourceAnchor = null;

        if (resourceSelected !== null) {
            resourceAnchor = resourceSelected.getElementsByTagName("a");
            if (resourceAnchor !== null && resourceAnchor[0].id !== undefined) {
                resourceId = resourceAnchor[0].id;
            }
        }

        if (previouslySelected !== null) {
            removeClass(previouslySelected, "usb-menu-item-selected");
        }
        addClass(elem.parentNode.parentNode, "usb-menu-item-selected");
        menuSelected.textContent = elem.textContent;
        setHiddenInputField(searchWidget, resourceId, menuSelected.textContent);
        searchQueryInput.focus();
        toggleMenu(cur);
    }


    /**
     * resourcesEventHandler() - handle menu item level events. Rerender the
     * unified search box as appropriate.
     * @param ev the event the resource menu is listening for.
     */
    function resourcesEventHandler(ev) {
        var elem = ev.target,
            cur = getParentOfTagName(elem, "UL"),
            menuSelected = cur.querySelector(".usb-menu-selected"),
            previouslySelected = cur.querySelector(".usb-menu-item-selected");

        if (previouslySelected !== null) {
            removeClass(previouslySelected, "usb-menu-item-selected");
        }
        addClass(elem.parentNode.parentNode, "usb-menu-item-selected");
        menuSelected.textContent = elem.textContent;

        resourceId = elem.id;
        updateQueryForm(searchWidget, searchQueryForm, resourceId);
        updateFilterMenu(searchWidget, filtersUL, searchQueryForm, resourceId, filtersEventHandler);
        filtersSelectButton.focus();
        toggleMenu(cur);
    }


    /**
     * init() - initialize and start our unified search box
     */
    function init() {
        var i = 0;
        /* Add mouse handling to menu */
        resourcesSelectButton.addEventListener("click", menuEventHandler, false);
        for (i = 0; i < resourcesMenuItems.length; i += 1) {
            addMenuItemListener(resourcesMenuItems[i], "click", resourcesEventHandler, false);
        }

        filtersSelectButton.addEventListener("click", menuEventHandler, false);
        for (i = 0; i < filtersMenuItems.length; i += 1) {
            addMenuItemListener(filtersMenuItems[i], "click", filtersEventHandler, false);
        }

        /* Add keyboard tab handling to menu */
        resourcesSelectButton.addEventListener("focus", menuEventHandler, false);
        filtersSelectButton.addEventListener("focus", menuEventHandler, false);

        /* Set the initial focus, filter and query form */
        updateQueryForm(searchWidget, searchQueryForm, resourceId);
        updateFilterMenu(searchWidget, filtersUL, searchQueryForm, resourceId);
        toggleMenu(resources);
        resourcesSelectButton.focus();
    }


    /* Setup and run our unified search box */
    init();
}(document));
</script>
<!--  END: js/usb.sj -->
